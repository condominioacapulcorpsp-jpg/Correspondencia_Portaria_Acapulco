<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Assinatura da Entrega</title>
<style>
  body { font-family: Arial; padding: 20px; }
  .thumb { width: 120px; border-radius: 6px; margin-right: 6px; }
  #canvas { border: 2px solid #111; width: 100%; height: 250px; touch-action: none; }
</style>
</head>
<body>

<h2>Assinatura da Entrega</h2>
<div id="info"></div>

<h3>Assine abaixo:</h3>
<canvas id="canvas"></canvas>
<br><br>
<button id="btnLimpar">Limpar</button>
<button id="btnSalvar">Salvar Assinatura</button>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const supabase = createClient("SEU_URL", "SEU_ANON_KEY");

const urlParams = new URLSearchParams(window.location.search);
const registroId = urlParams.get("registro");

async function carregar() {
  const { data, error } = await supabase
    .from("registros")
    .select("*")
    .eq("id", registroId)
    .single();

  if (error || !data) {
    document.getElementById("info").innerHTML = "<p>Registro n√£o encontrado.</p>";
    return;
  }

  document.getElementById("info").innerHTML = `
    <p><strong>Morador:</strong> ${data.nome}</p>
    <p><strong>Apartamento:</strong> ${data.apartamento}</p>
    <p><strong>Transportadora:</strong> ${data.transportadora || "--"}</p>
    <p><strong>Fotos:</strong></p>
    <div>
      ${data.foto_url ? `<img src="${data.foto_url}" class="thumb">` : ""}
      ${data.foto_url_2 ? `<img src="${data.foto_url_2}" class="thumb">` : ""}
      ${data.foto_url_3 ? `<img src="${data.foto_url_3}" class="thumb">` : ""}
    </div>
  `;
}
carregar();


// ==== CANVAS DE ASSINATURA ===
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
canvas.width = canvas.offsetWidth;
canvas.height = 250;

let desenhando = false;

canvas.addEventListener("pointerdown", e => {
  desenhando = true;
  ctx.moveTo(e.offsetX, e.offsetY);
});
canvas.addEventListener("pointermove", e => {
  if (!desenhando) return;
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.stroke();
});
canvas.addEventListener("pointerup", () => desenhando = false);


// ==== SALVAR ASSINATURA ====
document.getElementById("btnSalvar").onclick = async () => {
  const assinaturaBase64 = canvas.toDataURL("image/png");

  const nome = `assinatura-${registroId}.png`;
  const base64 = assinaturaBase64.split(",")[1];
  const bytes = atob(base64);
  const buf = new Uint8Array(bytes.length);
  for (let i = 0; i < bytes.length; i++) buf[i] = bytes.charCodeAt(i);

  // envia assinatura para o storage
  const { data: upload, error: uploadErr } = await supabase.storage
    .from("fotos")
    .upload(nome, buf, {
      contentType: "image/png",
      upsert: true
    });

  if (uploadErr) {
    alert("Erro ao salvar assinatura.");
    return;
  }

  const urlAss = supabase.storage.from("fotos").getPublicUrl(nome).data.publicUrl;

  // salva no banco
  const { error } = await supabase
    .from("registros")
    .update({
      assinatura_url: urlAss,
      status: "Entregue",
      delivered_at: new Date().toISOString(),
      delivered_by: "Morador"
    })
    .eq("id", registroId);

  if (error) {
    alert("Erro ao atualizar o registro.");
  } else {
    alert("Assinatura registrada com sucesso!");
    window.location.href = "https://seusite.com/";
  }
};

document.getElementById("btnLimpar").onclick = () => {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
};
</script>

</body>
</html>
