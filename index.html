<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portaria Acapulco</title>
<style>
/* === Estilos básicos === */
body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
input, button, select { padding: 6px; margin: 2px 0; }
button.btn { cursor: pointer; }
button.ghost { background: transparent; border: 1px solid #ccc; }
button.danger { background: #e74c3c; color: #fff; border: none; }
.thumb { width: 80px; height: 80px; object-fit: cover; border: 1px solid #ccc; }
.overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; }
.modal { background:#fff; padding:16px; border-radius:6px; max-width:90%; max-height:90%; overflow:auto; }
.tabs button.active { font-weight:bold; }
</style>
</head>
<body>

<h1>Portaria Acapulco</h1>

<!-- === TABS === -->
<div class="tabs">
  <button data-tab="moradores" class="active">Moradores</button>
  <button data-tab="registros">Registros</button>
  <button data-tab="relatorio">Relatório</button>
  <button data-tab="usuarios">Usuários</button>
</div>

<!-- === SECTIONS === -->
<div id="moradores">
  <h2>Cadastro de Moradores</h2>
  <input id="nomeInput" placeholder="Nome">
  <input id="aptInput" placeholder="Apartamento">
  <input id="whatsappInput" placeholder="Whatsapp">
  <button id="salvarMoradorBtn" class="btn">Salvar</button>
  <button id="limparFormularioBtn" class="btn ghost">Limpar</button>
  <div id="moradoresList"></div>

  <h2>Transportadoras</h2>
  <input id="novaTransportadora" placeholder="Nova transportadora">
  <button id="addTransportadoraBtn" class="btn">Adicionar</button>
  <div id="transportList"></div>

  <h2>Câmera</h2>
  <button id="abrirCameraBtn" class="btn">Abrir Câmera</button>
  <button id="capturarFotoBtn" class="btn" disabled>Capturar Foto</button>
  <button id="fecharCameraBtn" class="btn ghost" style="display:none">Fechar Câmera</button>
  <div id="cameraStatus">Câmera: fechada</div>
  <video id="video" autoplay playsinline style="width:100%; max-width:400px;"></video>
  <div id="fotosCapturadas" style="display:flex;gap:8px;flex-wrap:wrap"></div>
</div>

<div id="registros" style="display:none">
  <h2>Registros de Entregas</h2>
  <select id="selectMorador"></select>
  <select id="selectTransportadora"></select>
  <input id="obsInput" placeholder="Observações">
  <button id="salvarCorrespondenciaBtn" class="btn">Salvar Registro</button>
  <div id="statusSupabase"></div>
  <div id="recordsList"></div>
</div>

<div id="relatorio" style="display:none">
  <h2>Relatório</h2>
  <div id="relatorioContent"></div>
</div>

<div id="usuarios" style="display:none">
  <h2>Usuários</h2>
  <table id="tblUsuarios" border="1"></table>
  <h3>Novo Usuário</h3>
  <input id="novoUsuarioLogin" placeholder="Login">
  <input id="novoUsuarioNome" placeholder="Nome">
  <input id="novoUsuarioSenha" placeholder="Senha" type="password">
  <button id="btnAddUsuario" class="btn">Adicionar Usuário</button>
</div>

<div id="modalArea"></div>

<script>
// ====== VARIÁVEIS GLOBAIS ======
let residents=[], transports=[], records=[], users=[], capturedImages=[], editingResidentId=null;
let stream=null, currentUser={id:'1', name:'Admin', username:'admin'};
const supa=null; // Substituir pelo seu client Supabase
const BUCKET_FOTOS="fotos";

// ====== HELPERS ======
function uuid(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8); return v.toString(16); }); }
function escapeHtml(str){ if(!str) return ''; return str.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function normalizeWhatsapp(phone){ return phone.replace(/\D/g,'').replace(/^0+/,''); }
function getResident(id){ return residents.find(r=>r.id===id); }
function getResidentName(id){ const r=getResident(id); return r?r.name:''; }
function getResidentApartment(id){ const r=getResident(id); return r?r.apartment:''; }
function saveAll(){ localStorage.setItem('residents',JSON.stringify(residents)); localStorage.setItem('transports',JSON.stringify(transports)); localStorage.setItem('records',JSON.stringify(records)); localStorage.setItem('users',JSON.stringify(users)); }

// ====== RENDERIZAÇÃO ======
function renderResidents(){
  const container=document.getElementById('moradoresList'); container.innerHTML='';
  residents.forEach(r=>{
    const div=document.createElement('div'); div.innerHTML=`${escapeHtml(r.name)} - ${escapeHtml(r.apartment)} - ${escapeHtml(r.whatsapp||'')} <button class="btn" onclick="editResident('${r.id}')">Editar</button> <button class="btn danger" onclick="deleteResident('${r.id}')">Excluir</button>`;
    container.appendChild(div);
  });
  const sel=document.getElementById('selectMorador'); sel.innerHTML='<option value="">Selecione</option>';
  residents.forEach(r=>{ const o=document.createElement('option'); o.value=r.id; o.textContent=r.name; sel.appendChild(o); });
}
function renderTransports(){
  const container=document.getElementById('transportList'); container.innerHTML=''; transports.forEach(t=>{ const d=document.createElement('div'); d.textContent=t; container.appendChild(d); });
  const sel=document.getElementById('selectTransportadora'); sel.innerHTML='<option value="">Selecione</option>'; transports.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; sel.appendChild(o); });
}
function renderRecords(){
  const container=document.getElementById('recordsList'); container.innerHTML='';
  records.forEach(r=>{
    const div=document.createElement('div');
    div.innerHTML=`<strong>${escapeHtml(getResidentName(r.residentId)||'--')}</strong> - ${escapeHtml(r.transport||'--')} - ${escapeHtml(r.obs||'')} - ${r.status} 
      <button class="btn" onclick="openEditRecord('${r.id}')">Editar</button>
      <button class="btn" onclick="openShare('${r.id}')">Compartilhar</button>
      <button class="btn" onclick="darBaixa('${r.id}')">Dar Baixa</button>`;
    container.appendChild(div);
  });
}
function updateReports(){ document.getElementById('relatorioContent').innerHTML='Total registros: '+records.length; }

// ====== MORADORES ======
document.getElementById('salvarMoradorBtn').addEventListener('click', async ()=>{
  const nome=document.getElementById('nomeInput').value.trim();
  const apartment=document.getElementById('aptInput').value.trim();
  let whatsapp=document.getElementById('whatsappInput').value.trim();
  if(!nome) return alert('Preencha o nome');

  if(editingResidentId){
    const r=residents.find(x=>x.id===editingResidentId); if(!r) return;
    r.name=nome; r.apartment=apartment; r.whatsapp=whatsapp; editingResidentId=null; document.getElementById('salvarMoradorBtn').textContent='Salvar';
  } else {
    residents.push({id:uuid(), name:nome, apartment, whatsapp});
  }
  document.getElementById('nomeInput').value=''; document.getElementById('aptInput').value=''; document.getElementById('whatsappInput').value='';
  saveAll(); renderResidents(); renderTransports();
});
document.getElementById('limparFormularioBtn').addEventListener('click', ()=>{
  document.getElementById('nomeInput').value=''; document.getElementById('aptInput').value=''; document.getElementById('whatsappInput').value=''; editingResidentId=null; document.getElementById('salvarMoradorBtn').textContent='Salvar';
});
window.editResident=function(id){ const r=residents.find(x=>x.id===id); if(!r) return; document.getElementById('nomeInput').value=r.name; document.getElementById('aptInput').value=r.apartment; document.getElementById('whatsappInput').value=r.whatsapp||''; editingResidentId=id; document.getElementById('salvarMoradorBtn').textContent='Atualizar'; }
window.deleteResident=function(id){ if(!confirm('Excluir morador?')) return; residents=residents.filter(x=>x.id!==id); saveAll(); renderResidents(); renderRecords(); updateReports(); }

// ====== TRANSPORTADORAS ======
document.getElementById('addTransportadoraBtn').addEventListener('click', ()=>{ 
  const v=document.getElementById('novaTransportadora').value.trim(); if(!v) return; transports.push(v); document.getElementById('novaTransportadora').value=''; saveAll(); renderTransports();
});

// ====== CÂMERA ======
const video=document.getElementById('video'); const camArea=document.getElementById('cameraStatus'); const fotosCapturadas=document.getElementById('fotosCapturadas');
document.getElementById('abrirCameraBtn').addEventListener('click', async ()=>{
  try{ stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false}); video.srcObject=stream; camArea.textContent='Câmera: aberta'; document.getElementById('capturarFotoBtn').disabled=false; document.getElementById('fecharCameraBtn').style.display='inline-block'; }catch(e){ alert('Erro câmera: '+e.message); }
});
document.getElementById('capturarFotoBtn').addEventListener('click', ()=>{
  if(!stream) return; const c=document.createElement('canvas'); c.width=video.videoWidth||1280; c.height=video.videoHeight||720; c.getContext('2d').drawImage(video,0,0,c.width,c.height); capturedImages.push(c.toDataURL('image/jpeg',0.8)); renderCapturedThumbs();
});
document.getElementById('fecharCameraBtn').addEventListener('click', ()=>{ stopStream(); });
function stopStream(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; video.srcObject=null; camArea.textContent='Câmera: fechada'; document.getElementById('capturarFotoBtn').disabled=true; document.getElementById('fecharCameraBtn').style.display='none'; } }
function renderCapturedThumbs(){ fotosCapturadas.innerHTML=''; capturedImages.forEach((d,i)=>{ const img=document.createElement('img'); img.src=d; img.className='thumb'; const btn=document.createElement('button'); btn.textContent='Remover'; btn.className='btn ghost'; btn.onclick=()=>{ capturedImages.splice(i,1); renderCapturedThumbs(); }; const wrap=document.createElement('div'); wrap.style.display='flex'; wrap.style.flexDirection='column'; wrap.style.gap='6px'; wrap.appendChild(img); wrap.appendChild(btn); fotosCapturadas.appendChild(wrap); }); }

// ====== COMPARTILHAR WHATSAPP (AJUSTADO) ======
window.openShare=function(recordId){
  const rec=records.find(r=>r.id===recordId); if(!rec) return; const resident=getResident(rec.residentId); if(!resident){ alert('Morador não encontrado'); return; }
  const phone=normalizeWhatsapp(resident.whatsapp||''); if(!phone){ alert('Telefone do morador não cadastrado'); return; }
  const text=`Olá ${resident.name}, chegou uma entrega (${rec.obs||'sem descrição'}) pela transportadora ${rec.transport||'--'} às ${new Date(rec.createdAt).toLocaleString()}.`;
  const encoded=encodeURIComponent(text);
  // Link universal WhatsApp Web + App
  const url=`https://wa.me/${phone}?text=${encoded}`;
  window.open(url,'_blank');
}

// ====== GERAR LINK REGISTRO (AJUSTADO) ======
window.gerarLinkRegistro=function(recordId){
  const rec=records.find(r=>r.id===recordId); if(!rec) return;
  if(!rec.supabaseId){ alert('Este registro ainda não tem ID do Supabase'); return; }
  const resident=getResident(rec.residentId); if(!resident) return; const phone=normalizeWhatsapp(resident.whatsapp||''); if(!phone){ alert('Telefone do morador não cadastrado'); return; }
  const link=`${window.location.origin}/assinatura.html?registro=${rec.supabaseId}`;
  const msg=`Olá ${resident.name},\nChegou uma entrega para o apto ${resident.apartment}.\nPor favor, abra o link abaixo para assinar:\n${link}`;
  const encoded=encodeURIComponent(msg);
  const url=`https://wa.me/${phone}?text=${encoded}`;
  window.open(url,'_blank');
}

// ====== INICIALIZAÇÃO ======
renderTransports(); renderResidents(); renderRecords(); updateReports();
</script>

</body>
</html>
